<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>代码助手</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/vs2015.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 15px;
            background: var(--vscode-editor-background);
            color: var(--vscode-editor-foreground);
            font-family: var(--vscode-font-family);
            height: 100vh;
            box-sizing: border-box;
        }
        
        *, *:before, *:after {
            box-sizing: inherit;
        }

        .chat-container {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .messages {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 15px;
            padding: 10px;
        }

        .message {
            margin: 8px 0;
            padding: 8px 12px;
            border-radius: 6px;
            max-width: 80%;
            word-wrap: break-word;
        }
        .user-message {
            background: var(--vscode-button-background);
            color: var(--vscode-button-foreground);
            margin-left: auto;
        }
        .ai-message {
            background: var(--vscode-editor-inactiveSelectionBackground);
            margin-right: auto;
        }
        .input-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding: 15px;
            background: var(--vscode-editor-background);
            border-top: 1px solid var(--vscode-widget-border);
        }
        .input-area {
            display: flex;
            gap: 10px;
            align-items: flex-start;
        }
        .input-box {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 8px;
            background: var(--vscode-input-background);
            border: 1px solid var(--vscode-input-border);
            border-radius: 6px;
            padding: 8px;
        }
        #messageInput {
            width: 100%;
            min-height: 40px;
            max-height: 200px;
            resize: none;
            border: none;
            background: transparent;
            color: var(--vscode-input-foreground);
            font-family: inherit;
            font-size: 14px;
            line-height: 1.5;
            outline: none;
        }
        .input-actions {
            display: flex;
            gap: 8px;
            align-items: center;
            padding-top: 4px;
            border-top: 1px solid var(--vscode-widget-border);
            justify-content: space-between;
        }
        .input-actions-left, .input-actions-right {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        .action-button {
            padding: 4px 8px;
            background: transparent;
            color: var(--vscode-button-foreground);
            border: none;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 12px;
            opacity: 0.8;
        }
        .action-button:hover {
            background: var(--vscode-button-hoverBackground);
            opacity: 1;
        }
        .context-button {
            color: var(--vscode-textLink-foreground);
            opacity: 0.8;
        }
        .context-button:hover {
            opacity: 1;
            background: var(--vscode-textLink-activeForeground);
        }
        .action-button svg {
            width: 16px;
            height: 16px;
            fill: currentColor;
        }
        .send-button {
            background: var(--vscode-button-background);
            color: var(--vscode-button-foreground);
        }
        .send-button:hover {
            background: var(--vscode-button-hoverBackground);
        }
        .send-button svg {
            width: 16px;
            height: 16px;
            fill: currentColor;
        }
        .preview-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 5px;
        }
        .image-preview {
            position: relative;
            width: 100px;
            height: 100px;
            border-radius: 4px;
            overflow: hidden;
        }
        .image-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .image-preview .remove {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(0,0,0,0.5);
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .message img {
            max-width: 100%;
            border-radius: 4px;
            margin: 5px 0;
        }
        .generate-code-btn {
            display: none;
            margin-top: 8px;
            padding: 4px 8px;
            background: var(--vscode-button-background);
            color: var(--vscode-button-foreground);
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button {
            padding: 8px 16px;
            background: var(--vscode-button-background);
            color: var(--vscode-button-foreground);
            border: none;
            border-radius: 4px;
            cursor: pointer;
            white-space: nowrap;
        }
        button:hover {
            background: var(--vscode-button-hoverBackground);
        }
        .loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            color: white;
        }
        
        .loading.active {
            display: flex;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--vscode-button-background);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .message pre {
            margin: 8px 0;
            padding: 12px;
            border-radius: 4px;
            background: var(--vscode-editor-background);
            overflow-x: auto;
        }
        
        .message code {
            font-family: var(--vscode-editor-font-family);
            font-size: 14px;
        }
        
        .message p {
            margin: 8px 0;
        }
        
        .ai-message pre {
            background: var(--vscode-editor-background);
            border: 1px solid var(--vscode-widget-border);
        }
        .context-menu {
            position: absolute;
            background: var(--vscode-editor-background);
            border: 1px solid var(--vscode-widget-border);
            border-radius: 4px;
            padding: 4px 0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            display: none;
        }
        
        .context-menu.active {
            display: block;
        }
        
        .context-menu-item {
            padding: 6px 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--vscode-foreground);
            font-size: 13px;
            white-space: nowrap;
        }
        
        .context-menu-item:hover {
            background: var(--vscode-list-hoverBackground);
        }
        
        .context-menu-item svg {
            width: 16px;
            height: 16px;
            fill: currentColor;
        }
        
        .message img {
            cursor: pointer;
            transition: opacity 0.2s;
        }
        
        .message img:hover {
            opacity: 0.8;
        }

        .context-panel {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            background: var(--vscode-editor-background);
            border: 1px solid var(--vscode-widget-border);
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            padding: 8px;
        }

        .context-panel.active {
            display: block;
        }

        .context-panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            border-bottom: 1px solid var(--vscode-widget-border);
        }

        .context-panel-title {
            font-size: 13px;
            font-weight: 500;
            color: var(--vscode-foreground);
        }

        .context-panel-close {
            background: none;
            border: none;
            color: var(--vscode-foreground);
            cursor: pointer;
            padding: 4px;
            opacity: 0.7;
        }

        .context-panel-close:hover {
            opacity: 1;
        }

        .context-panel-content {
            padding: 12px;
        }

        .search-box {
            width: 100%;
            padding: 6px 8px;
            background: var(--vscode-input-background);
            border: 1px solid var(--vscode-input-border);
            border-radius: 4px;
            color: var(--vscode-input-foreground);
            font-size: 13px;
            margin-bottom: 8px;
        }

        .file-section {
            margin-top: 8px;
        }

        .file-section-header {
            padding: 6px 8px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--vscode-sideBarTitle-foreground);
            opacity: 0.8;
        }

        .file-item {
            display: flex;
            align-items: center;
            padding: 4px 8px;
            cursor: pointer;
            border-radius: 4px;
        }

        .file-item:hover {
            background: var(--vscode-list-hoverBackground);
        }

        .file-item.selected {
            background: var(--vscode-list-activeSelectionBackground);
            color: var(--vscode-list-activeSelectionForeground);
        }

        .file-item.selected .file-path {
            color: var(--vscode-list-activeSelectionForeground);
            opacity: 0.7;
        }

        .file-item-content {
            display: flex;
            align-items: center;
            gap: 6px;
            flex: 1;
        }

        .file-name {
            flex: 1;
            font-size: 13px;
        }

        .file-path {
            color: var(--vscode-descriptionForeground);
            font-size: 12px;
            opacity: 0.8;
            text-align: right;
            margin-left: 8px;
        }

        .file-icon {
            width: 16px;
            height: 16px;
            opacity: 0.8;
        }

        #addedFiles {
            margin-bottom: 8px;
        }
        
        #addedFiles:empty {
            display: none;
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="loading" id="loading">
            <div class="loading-spinner"></div>
            <div>正在生成代码...</div>
        </div>
        <div class="messages" id="messages">
            <div class="message ai-message">你好！我是你的代码助手，有什么可以帮你的吗？</div>
        </div>
        <div id="selectedContext"></div>
        <div class="context-menu" id="imageContextMenu">
            <div class="context-menu-item" onclick="handleAnalyzeImage()">
                <svg viewBox="0 0 24 24">
                    <path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>
                </svg>
                分析图片
            </div>
            <div class="context-menu-item" onclick="handleGenerateVariation()">
                <svg viewBox="0 0 24 24">
                    <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 14l-4-4h3V9h2v4h3l-4 4z"/>
                </svg>
                生成变体
            </div>
        </div>
        <div class="input-container">
            <div class="preview-container" id="previewContainer"></div>
            <div class="input-area">
                <div class="input-box">
                    <textarea
                        id="messageInput"
                        placeholder="输入消息... (可以粘贴图片)"
                        onpaste="handlePaste(event)"
                    ></textarea>
                    <div class="input-actions">
                        <div class="input-actions-left">
                            <button class="action-button" onclick="handleImageUpload()">
                                <svg viewBox="0 0 24 24">
                                    <path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/>
                                </svg>
                                添加图片
                            </button>
                        </div>
                        <div class="input-actions-right">
                            <button class="action-button context-button" onclick="handleAddContext()">
                                <svg viewBox="0 0 16 16" width="16" height="16">
                                    <path d="M7.5 1.5C4.47 1.5 2 3.97 2 7s2.47 5.5 5.5 5.5c3.03 0 5.5-2.47 5.5-5.5S10.53 1.5 7.5 1.5zm0 1a4.5 4.5 0 1 1 0 9 4.5 4.5 0 0 1 0-9zM7 4v3.5l3 1.5-.5.9L6 8V4h1z"/>
                                </svg>
                                Add Context
                            </button>
                            <button class="action-button send-button" onclick="sendMessage()">
                                <svg viewBox="0 0 16 16" width="16" height="16">
                                    <path d="M15.854.146a.5.5 0 0 1 .11.54l-5.819 14.547a.5.5 0 0 1-.898.03l-2.777-4.445-4.445-2.777a.5.5 0 0 1 .03-.898L14.546.002a.5.5 0 0 1 .54.11z"/>
                                </svg>
                                发送
                            </button>
                        </div>
                    </div>
                    <div class="context-panel" id="contextPanel">
                        <input 
                            type="text" 
                            class="search-box" 
                            placeholder="Search files by name" 
                            onclick="handleSearchClick(event)"
                            readonly
                        >
                        <div class="file-section">
                            <div class="file-section-header">ADDED</div>
                            <div id="addedFiles"></div>
                        </div>
                        <div class="file-section">
                            <div class="file-section-header">AVAILABLE</div>
                            <div id="availableFiles"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
    </div>
    <script>
        const vscode = acquireVsCodeApi();
        const messagesDiv = document.getElementById('messages');
        const messageInput = document.getElementById('messageInput');
        const previewContainer = document.getElementById('previewContainer');
        const loadingElement = document.getElementById('loading');
        const contextMenu = document.getElementById('imageContextMenu');
        let currentImage = null;
        let currentContextImage = null;

        function showLoading() {
            loadingElement.classList.add('active');
        }
        
        function hideLoading() {
            loadingElement.classList.remove('active');
        }

        function addMessage(text, isAI = false, image = null) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message ' + (isAI ? 'ai-message' : 'user-message');
            
            if (image) {
                const img = document.createElement('img');
                img.src = image;
                img.onclick = (e) => handleImageClick(e, img);
                messageDiv.appendChild(img);
                
                if (!isAI) {
                    const generateBtn = document.createElement('button');
                    generateBtn.className = 'generate-code-btn';
                    generateBtn.textContent = '生成代码';
                    generateBtn.style.display = 'block';
                    generateBtn.onclick = () => {
                        vscode.postMessage({
                            command: 'generateCode',
                            image: image
                        });
                    };
                    messageDiv.appendChild(generateBtn);
                }
            }
            
            if (text) {
                const textDiv = document.createElement('div');
                if (isAI) {
                    marked.setOptions({
                        highlight: function(code, lang) {
                            if (lang && hljs.getLanguage(lang)) {
                                return hljs.highlight(code, { language: lang }).value;
                            }
                            return hljs.highlightAuto(code).value;
                        }
                    });
                    textDiv.innerHTML = marked.parse(text);
                } else {
                    textDiv.textContent = text;
                }
                messageDiv.appendChild(textDiv);
            }
            
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function handlePaste(e) {
            const items = e.clipboardData.items;
            for (let item of items) {
                if (item.type.indexOf('image') !== -1) {
                    const file = item.getAsFile();
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        currentImage = event.target.result;
                        updatePreview();
                    };
                    reader.readAsDataURL(file);
                    break;
                }
            }
        }

        function updatePreview() {
            previewContainer.innerHTML = '';
            if (currentImage) {
                const previewDiv = document.createElement('div');
                previewDiv.className = 'image-preview';
                previewDiv.innerHTML = `
                    <img src="${currentImage}">
                    <button class="remove" onclick="removeImage()">×</button>
                `;
                previewContainer.appendChild(previewDiv);
            }
        }

        function removeImage() {
            currentImage = null;
            updatePreview();
        }

        function sendMessage() {
            const text = messageInput.value.trim();
            if (text || currentImage) {
                addMessage(text, false, currentImage);
                vscode.postMessage({
                    command: 'sendMessage',
                    text: text,
                    image: currentImage
                });
                messageInput.value = '';
                currentImage = null;
                updatePreview();
            }
        }

        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        window.addEventListener('message', event => {
            const message = event.data;
            switch (message.command) {
                case 'receiveMessage':
                    addMessage(message.text, message.isAI, message.image);
                    break;
                case 'showLoading':
                    showLoading();
                    break;
                case 'hideLoading':
                    hideLoading();
                    break;
                case 'fileList':
                    window.currentFiles = message.files;
                    renderFileList(message.files);
                    break;
                case 'selectedFiles':
                    const searchBox = document.querySelector('.search-box');
                    if (message.files && message.files.length > 0) {
                        searchBox.value = message.files.map(f => f.name).join(', ');
                        renderFileList(message.files);
                    }
                    break;
            }
        });

        // 处理图片点击事件，显示上下文菜单
        function handleImageClick(event, image) {
            event.preventDefault();
            currentContextImage = image;
            
            const rect = image.getBoundingClientRect();
            contextMenu.style.top = `${rect.bottom + 5}px`;
            contextMenu.style.left = `${rect.left}px`;
            contextMenu.classList.add('active');
        }

        // 点击其他地方时隐藏上下文菜单
        document.addEventListener('click', (e) => {
            if (!contextMenu.contains(e.target) && !e.target.matches('img')) {
                contextMenu.classList.remove('active');
            }
        });

        // 分析图片
        function handleAnalyzeImage() {
            if (!currentContextImage) return;
            
            vscode.postMessage({
                command: 'analyzeImage',
                image: currentContextImage.src
            });
            
            contextMenu.classList.remove('active');
        }

        // 生成图片变体
        function handleGenerateVariation() {
            if (!currentContextImage) return;
            
            vscode.postMessage({
                command: 'generateVariation',
                image: currentContextImage.src
            });
            
            contextMenu.classList.remove('active');
        }

        function handleImageUpload() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        currentImage = event.target.result;
                        updatePreview();
                    };
                    reader.readAsDataURL(file);
                }
            };
            input.click();
        }

        function handleAddContext() {
            const panel = document.getElementById('contextPanel');
            panel.classList.add('active');
            
            // 直接触发文件选择
            handleSearchClick(new Event('click'));
        }

        function closeContextPanel() {
            const panel = document.getElementById('contextPanel');
            panel.classList.remove('active');
        }

        function handleSearchClick(event) {
            event.preventDefault();
            event.stopPropagation();
            
            // 请求打开文件选择对话框
            vscode.postMessage({
                command: 'getWorkspaceFiles'
            });
        }

        function renderFileList(files = []) {
            const addedFiles = document.getElementById('addedFiles');
            const availableFiles = document.getElementById('availableFiles');
            
            // 清空现有内容
            addedFiles.innerHTML = '';
            availableFiles.innerHTML = '';
            
            if (!files || files.length === 0) {
                availableFiles.innerHTML = `
                    <div class="file-item">
                        <div class="file-item-content">
                            <svg class="file-icon" viewBox="0 0 16 16">
                                <path d="M1.5 14h13l.5-.5V3.707L13.293 2H8.5l-.354-.146L7.793 1H2.5l-.5.5v12l-.5.5z"/>
                            </svg>
                            <span class="file-name">选择文件夹...</span>
                        </div>
                    </div>
                `;
                return;
            }

            // 添加已选择的文件到 ADDED 部分
            const selectedFiles = files.filter(f => f.selected);
            if (selectedFiles.length > 0) {
                selectedFiles.forEach(file => {
                    const fileItem = createFileItem(file, true);
                    // 为已选择的文件添加点击取消选择功能
                    fileItem.onclick = () => selectFile(file);
                    addedFiles.appendChild(fileItem);
                });
            }

            // 添加未选择的文件到 AVAILABLE 部分
            const availableFilesList = files.filter(f => !f.selected);
            availableFilesList.forEach(file => {
                const fileItem = createFileItem(file, false);
                fileItem.onclick = () => selectFile(file);
                availableFiles.appendChild(fileItem);
            });

            // 更新搜索框显示
            updateSearchBoxDisplay(selectedFiles);
        }

        function selectFile(file) {
            // 更新文件的选中状态
            file.selected = !file.selected;
            
            // 获取当前所有文件
            const allFiles = window.currentFiles || [];
            const fileIndex = allFiles.findIndex(f => f.path === file.path);
            if (fileIndex !== -1) {
                allFiles[fileIndex].selected = file.selected;
            }
            window.currentFiles = allFiles;

            // 重新渲染文件列表
            renderFileList(allFiles);
            
            // 通知扩展选择了文件
            vscode.postMessage({
                command: 'selectFile',
                files: allFiles.filter(f => f.selected)
            });
        }

        function updateSearchBoxDisplay(selectedFiles) {
            const searchBox = document.querySelector('.search-box');
            if (selectedFiles && selectedFiles.length > 0) {
                searchBox.value = selectedFiles.map(f => f.name).join(', ');
            } else {
                searchBox.value = '';
                searchBox.placeholder = 'Search files by name';
            }
        }

        // 添加一个全局变量来存储文件列表
        window.currentFiles = [];

        function createFileItem(file, isSelected) {
            const fileItem = document.createElement('div');
            fileItem.className = `file-item${isSelected ? ' selected' : ''}`;
            if (!isSelected) {
                fileItem.onclick = () => selectFile(file);
            }

            // 获取文件图标
            const iconPath = getFileIcon(file.type);
            
            fileItem.innerHTML = `
                <div class="file-item-content">
                    <svg class="file-icon" viewBox="0 0 16 16">
                        <path d="${iconPath}"/>
                    </svg>
                    <span class="file-name">${file.name}</span>
                    <span class="file-path">${file.path}</span>
                </div>
            `;
            return fileItem;
        }

        function getFileIcon(fileType) {
            // 根据文件类型返回不同的图标路径
            const icons = {
                'ts': 'M5 3l.777-.416L7 4.25v7.5L5.777 13.416 4 13V3h1zm4 0l-.777-.416L7 4.25v7.5l1.223 1.666L10 13V3H9z',
                'js': 'M3 3h10v10H3V3zm8.5 8a2.5 2.5 0 1 1 0-5 2.5 2.5 0 0 1 0 5zm-7-2.5a2.5 2.5 0 1 1 5 0 2.5 2.5 0 0 1-5 0z',
                'html': 'M4 1L3 2v12l1 1h8l1-1V2l-1-1H4zm0 1h8v12H4V2zm2 2v1h4V4H6zm0 2v1h4V6H6zm0 2v1h4V8H6zm0 2v1h4v-1H6z',
                'default': 'M13.5 3h-3L9.5 1h-5L3.5 3h-3v10h13V3zm-13 9V4h3.1l1-2h4.8l1 2h3.1v8h-13z'
            };
            return icons[fileType] || icons.default;
        }

        function updateSelectedContext(file) {
            const selectedContext = document.getElementById('selectedContext');
            if (file) {
                selectedContext.innerHTML = `
                    <div class="selected-context">
                        <div class="selected-file">
                            <div class="selected-file-info">
                                <svg class="file-icon" viewBox="0 0 16 16">
                                    <path d="M13.5 3h-3L9.5 1h-5L3.5 3h-3v10h13V3zm-13 9V4h3.1l1-2h4.8l1 2h3.1v8h-13z"/>
                                </svg>
                                <span class="selected-file-name">${file.name}</span>
                                <span class="selected-file-path">${file.path.split('/').slice(0, -1).join('/')}/</span>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                selectedContext.innerHTML = '';
            }
        }
    </script>
</body>
</html> 